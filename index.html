<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservar Cambio de Aceite</title>
  <style>
    :root{--accent:#0b5ed7;--bg:#f5f7fb;--card:#ffffff;--muted:#6b7280}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#1f2937}
    .container{max-width:820px;margin:32px auto;padding:20px}
    .card{background:var(--card);border-radius:12px;padding:26px;box-shadow:0 6px 20px rgba(15,23,42,0.08)}
    h1{margin:0 0 6px;font-size:24px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin-top:12px;font-weight:600;color:#111827}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;font-size:15px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{background:var(--accent);color:white;border:none;padding:12px 16px;border-radius:8px;font-weight:700;margin-top:18px;cursor:pointer}
    button[disabled]{opacity:0.55;cursor:not-allowed}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    .success{padding:12px;border-radius:8px;margin-top:14px}
    .success.ok{background:#ecfdf5;color:#064e3b}
    .success.err{background:#fff1f2;color:#7f1d1d}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Reserva de cambio de aceite a domicilio</h1>
      <p class="lead">Rellena tus datos. La cita debe hacerse con <strong>mínimo 24 horas</strong> de antelación.</p>

      <form id="reservaForm">
        <label>Nombre completo</label>
        <input name="nombre" required />

        <div class="row">
          <div class="col">
            <label>Teléfono</label>
            <input name="telefono" required placeholder="ej. +1 809 555 1234" />
          </div>
          <div class="col">
            <label>Correo</label>
            <input name="correo" type="email" required placeholder="cliente@correo.com" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Marca</label>
            <input name="marca" required />
          </div>
          <div class="col">
            <label>Modelo</label>
            <input name="modelo" required />
          </div>
          <div class="col">
            <label>Año</label>
            <input name="ano" type="number" min="1900" max="2100" required />
          </div>
        </div>

        <label>Tipo de Aceite (si lo sabe)</label>
        <select name="tipoAceite">
          <option value="">No lo sé / Otro</option>
          <option value="Convencional">Convencional</option>
          <option value="Semi-Sintético">Semi-Sintético</option>
          <option value="Sintético">Sintético</option>
        </select>

        <label>Dirección donde se realizará el servicio</label>
        <textarea name="direccion" rows="2" required></textarea>

        <div class="row">
          <div class="col">
            <label>Fecha</label>
            <input id="fecha" name="fecha" type="date" required />
          </div>
          <div class="col">
            <label>Hora</label>
            <input id="hora" name="hora" type="time" required />
          </div>
        </div>

        <label>Comentarios</label>
        <textarea name="comentarios" rows="2"></textarea>

        <div style="margin-top:14px" class="note">
          <div style="background:#fafafa;border:1px solid #eef2ff;padding:12px;border-radius:8px">
            <strong>Acuerdo:</strong> La reserva debe realizarse con <strong>mínimo 24 horas</strong> de antelación. El mecánico realizará únicamente el cambio de aceite y filtro y no será responsable por daños no relacionados directamente con este servicio. Cualquier recomendación adicional no se aplicará hasta contar con la aprobación previa del cliente.
          </div>
          <label style="margin-top:8px"><input id="acepto" type="checkbox" required />&nbsp; Acepto los términos</label>
        </div>

        <button id="submitBtn" type="submit">Reservar</button>
        <div id="msg" class="success" style="display:none"></div>
      </form>
    </div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQPY-O7N2uJy_wAvnE-zyQP90Zteq_MvtQNl70T-bnb3hTrWda1CfFEU0WlhsVpWBUWw/exec";

function showMsg(text, ok=true){
  const el = document.getElementById('msg');
  el.style.display = 'block';
  el.textContent = text;
  el.className = ok ? 'success ok' : 'success err';
}

async function fetchReservations(){
  try{
    const res = await fetch(SCRIPT_URL + '?action=list');
    if(!res.ok) return [];
    const data = await res.json();
    return data;
  }catch(e){
    console.warn('No se pudo obtener reservas', e);
    return [];
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const reserved = await fetchReservations();
  const busy = new Set(reserved.map(r => `${r.Fecha}|${r.Hora}`));

  const form = document.getElementById('reservaForm');
  const submitBtn = document.getElementById('submitBtn');

  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    showMsg('', true);
    const fd = new FormData(form);
    const obj = Object.fromEntries(fd.entries());

    const fecha = obj.fecha;
    const hora = obj.hora;
    const dt = new Date(fecha + 'T' + hora + ':00');
    const now = new Date();
    const diffH = (dt - now) / (1000*60*60);
    if(diffH < 24){
      showMsg('Debes reservar con al menos 24 horas de anticipación.', false);
      return;
    }

    if(busy.has(`${fecha}|${hora}`)){
      showMsg('Ese horario ya está ocupado. Por favor elige otra hora.', false);
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    try{
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      const json = await res.json();
      if(json.result === 'success'){
        showMsg('✅ Reserva registrada correctamente.', true);
        form.reset();
      } else {
        showMsg('⛔ ' + (json.message || 'Error al registrar'), false);
      }
    }catch(e){
      showMsg('❌ Error al enviar la reserva.', false);
      console.error(e);
    }finally{
      submitBtn.disabled = false;
      submitBtn.textContent = 'Reservar';
    }
  });
});
</script>
</body>
</html>
